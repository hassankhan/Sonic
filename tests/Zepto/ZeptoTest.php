<?php
namespace Zepto;

/**
 * Generated by PHPUnit_SkeletonGenerator 1.2.1 on 2013-11-20 at 00:37:02.
 */
class ZeptoTest extends \PHPUnit_Framework_TestCase
{

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    protected function setUp()
    {
        $_SERVER['DOCUMENT_ROOT']   = '/var/www';
        $_SERVER['SCRIPT_FILENAME'] = '/var/www/zepto/index.php';
        $_SERVER['SERVER_NAME']     = 'zepto';
        $_SERVER['SERVER_PORT']     = '80';
        $_SERVER['SCRIPT_NAME']     = '/zepto/';
        $_SERVER['REQUEST_URL']     = '/zepto/';
        $_SERVER['REQUEST_URI']     = '/zepto/';
        $_SERVER['PATH_INFO']       = '/bar/xyz';
        $_SERVER['REQUEST_METHOD']  = 'GET';
        $_SERVER['QUERY_STRING']    = 'one=1&two=2&three=3';
        $_SERVER['HTTPS']           = '';
        $_SERVER['REMOTE_ADDR']     = '127.0.0.1';
        unset($_SERVER['CONTENT_TYPE'], $_SERVER['CONTENT_LENGTH']);

        // Change this to a dataprovider
        include ROOT_DIR . 'config.php';
        $this->config = $config;
    }

    /**
     * Tears down the fixture, for example, closes a network connection.
     * This method is called after a test is executed.
     */
    protected function tearDown()
    {
    }

    /**
     * CONSTRUCTOR TESTS
     */

    /**
     * @covers Zepto\Zepto::__construct()
     * @covers Zepto\Zepto::default_config()
     * @covers Zepto\Zepto::validate_config()
     */
    public function testConstructWithSettings()
    {
        ob_start();
        $config = array(
            'zepto' => array(
                'environment'       => 'prod',
                'content_dir'       => 'content',
                'plugins_dir'       => 'plugins',
                'templates_dir'     => 'templates',
                'default_template'  => 'base.twig',
                'content_ext'       => array('.md', '.markdown'),
                'plugins_enabled'   => true
            ),
            'site' => array(
                'site_root'         => 'http://www.zepto.com/',
                'site_title'        => 'Zepto',
                'date_format'       => 'jS M Y',
                'excerpt_length'    => '50',
                'nav'               => array(
                    'class'             => 'nav',
                    'dropdown_li_class' => 'dropdown',
                    'dropdown_ul_class' => 'dropdown-menu'
                )
            ),
            'twig' => array(
                'charset'           => 'utf-8',
                'cache'             => 'cache',
                'strict_variables'  => false,
                'autoescape'        => false,
                'auto_reload'       => true
            )
        );
        $zepto = new Zepto($config);
        $this->assertEquals($config, $zepto->container['settings']);
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::__construct()
     * @covers Zepto\Zepto::default_config()
     */
    public function testRouterAdded()
    {
        ob_start();
        $zepto = new Zepto();
        $this->assertArrayHasKey('router', $zepto->container);
        $this->assertInstanceOf(
            'Zepto\Router',
            $zepto->container['router']
        );
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::__construct()
     * @covers Zepto\Zepto::default_config()
     */
    public function testPluginLoaderAdded()
    {
        ob_start();
        $zepto = new Zepto();
        $this->assertArrayHasKey('plugin_loader', $zepto->container);
        $this->assertInstanceOf(
            'Zepto\FileLoader\PluginLoader',
            $zepto->container['plugin_loader']
        );
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::__construct()
     * @covers Zepto\Zepto::default_config()
     */
    public function testContentLoaderAdded()
    {
        ob_start();
        $zepto = new Zepto();
        $this->assertArrayHasKey('content_loader', $zepto->container);
        $this->assertInstanceOf(
            'Zepto\FileLoader\MarkdownLoader',
            $zepto->container['content_loader']
        );
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::__construct()
     * @covers Zepto\Zepto::default_config()
     */
    public function testTwigAdded()
    {
        ob_start();
        $zepto = new Zepto();
        $this->assertArrayHasKey('twig', $zepto->container);
        $this->assertInstanceOf(
            '\Twig_Environment',
            $zepto->container['twig']
        );
        ob_end_clean();
    }

    /**
     * INITIALIZATION TESTS
     */

    /**
     * @covers Zepto\Zepto::load_plugins()
     */
    public function testLoadPlugins()
    {
        ob_start();
        // Add assertion to check if plugins_enabled is true or not
        $zepto = new Zepto();
        $this->assertArrayHasKey('plugins', $zepto->container);
        $plugins = $zepto->container['plugins'];
        $this->assertArrayHasKey('ExamplePlugin', $zepto->container['plugins']);
        $this->assertArrayHasKey('OtherExamplePlugin', $zepto->container['plugins']);
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::load_plugins()
     */
    public function testLoadPluginsWhenDisabled()
    {
        ob_start();
        // Add assertion to check if plugins_enabled is true or not
        $config = Zepto::default_config();
        $config['zepto']['plugins_enabled'] = false;
        $zepto = new Zepto($config);
        $this->assertArrayNotHasKey('plugins', $zepto->container);
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::load_content()
     * @todo Implement testLoadContent()
     */
    public function testLoadContent()
    {
        ob_start();
        $zepto = new Zepto();
        // $this->markTestIncomplete('Not yet implemented');
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::create_nav_links()
     * @covers Zepto\Zepto::generate_nav_html()
     */
    public function testCreateNavLinks()
    {
        ob_start();
        $zepto = new Zepto();

        $expected = '<ul class="nav">' . PHP_EOL
            . '<li><a href="http://localhost:8888/zepto/"> Welcome </a></li>' . PHP_EOL
            . '<li class="dropdown">' . PHP_EOL
            . '<a href="index.md" class="dropdown-toggle" data-toggle="dropdown"> Sub <b class="caret"></b></a>' . PHP_EOL
            . '<ul class="dropdown-menu">' . PHP_EOL
            . '<li><a href="http://localhost:8888/zepto/sub/"> Sub Page Index </a></li>' . PHP_EOL
            . '<li><a href="http://localhost:8888/zepto/sub/page"> Sub Page </a></li>' . PHP_EOL
            . '</ul></li>' . PHP_EOL
            . '</ul>' . PHP_EOL;

        $this->assertEquals(array('nav' => $expected), $zepto->container['nav']);
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::setup_router()
     */
    public function testRouterSetup()
    {
        ob_start();
        $zepto = new Zepto();
        $routes = $zepto->container['router']->routes();

        // Check that routes were added as HTTP GET requests
        $this->assertArrayHasKey('GET', $routes);

        // Check to see only expected routes
        $expected = array('#^/404/$#', '#^/$#', '#^/sub/$#', '#^/sub/page/$#');

        // Check that all routes have a callback function
        $this->assertContainsOnly('Zepto\Route', $routes['GET']);

        foreach ($expected as $route_regex) {
            $this->assertArrayHasKey($route_regex, $routes['GET']);
        }
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::run
     * @todo   Implement testRun().
     */
    public function testRun()
    {
        ob_start();
        $zepto = new Zepto();

        // Check to see that the index page has loaded
        // Remove the following lines when you implement this test.
        // $this->markTestIncomplete(
        //   'This test has not been implemented yet.'
        // );
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::run_hooks
     */
    public function testRunHooks()
    {
        ob_start();
        $zepto = new Zepto();
        $this->assertTrue($zepto->run_hooks('before_response_send'));
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::run_hooks
     */
    public function testRunHooksReturnsFalseWhenPluginsAreDisabled()
    {
        ob_start();
        $config = Zepto::default_config();
        $config['zepto']['plugins_enabled'] = false;
        $zepto = new Zepto($config);
        $this->assertFalse($zepto->run_hooks('before_response_send'));
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::validate_config()
     */
    public function testValidateConfig()
    {
        ob_start();
        $config = Zepto::default_config();
        $this->assertTrue(Zepto::validate_config($config));
    }

    /**
     * @covers            Zepto\Zepto::validate_config()
     * @expectedException InvalidArgumentException
     */
    public function testConfigWithInvalidContentDir()
    {
        ob_start();
        $config = Zepto::default_config();
        $config['zepto']['content_dir'] = 'no_such_dir';
        Zepto::validate_config($config);
    }

    /**
     * @covers            Zepto\Zepto::validate_config()
     * @expectedException InvalidArgumentException
     */
    public function testConfigWithInvalidPluginsDir()
    {
        ob_start();
        $config = Zepto::default_config();
        $config['zepto']['plugins_dir'] = 'no_such_dir';
        Zepto::validate_config($config);
    }

    /**
     * @covers            Zepto\Zepto::validate_config()
     * @expectedException InvalidArgumentException
     */
    public function testConfigWithInvalidTemplatesDir()
    {
        ob_start();
        $config = Zepto::default_config();
        $config['zepto']['templates_dir'] = 'no_such_dir';
        Zepto::validate_config($config);
    }

    /**
     * @covers            Zepto\Zepto::validate_config()
     * @expectedException InvalidArgumentException
     */
    public function testConfigWithInvalidSiteRoot()
    {
        ob_start();
        $config = Zepto::default_config();
        $config['site']['site_root'] = 'fuck://this@should?fail';
        Zepto::validate_config($config);
    }

}
