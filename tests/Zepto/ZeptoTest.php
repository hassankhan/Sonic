<?php
namespace Zepto;

/**
 * Generated by PHPUnit_SkeletonGenerator 1.2.1 on 2013-11-20 at 00:37:02.
 */
class ZeptoTest extends \PHPUnit_Framework_TestCase
{

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    protected function setUp()
    {
        // Set superglobals to define application state
        $_SERVER['DOCUMENT_ROOT']   = '/var/www';
        $_SERVER['SCRIPT_FILENAME'] = '/var/www/zepto/index.php';
        $_SERVER['SERVER_NAME']     = 'zepto';
        $_SERVER['SERVER_PORT']     = '80';
        $_SERVER['SCRIPT_NAME']     = '/zepto/';
        $_SERVER['REQUEST_URL']     = '';
        $_SERVER['REQUEST_URI']     = '';
        $_SERVER['REQUEST_METHOD']  = 'GET';
        $_SERVER['QUERY_STRING']    = '';
        $_SERVER['HTTPS']           = '';
        $_SERVER['REMOTE_ADDR']     = '127.0.0.1';
        unset($_SERVER['CONTENT_TYPE'], $_SERVER['CONTENT_LENGTH']);
    }

    /**
     * Tears down the fixture, for example, closes a network connection.
     * This method is called after a test is executed.
     */
    protected function tearDown()
    {
        Zepto::kill();
    }

    /**
     * CONSTRUCTOR TESTS
     */

    /**
     * @covers Zepto\Zepto::__construct()
     */
    public function testConstructWithCustomSettings()
    {
        $config = array(
            'zepto.environment'           => 'dev',
            'zepto.content_dir'           => 'content',
            'zepto.plugins_dir'           => 'plugins',
            'zepto.templates_dir'         => 'templates',
            'zepto.default_template'      => 'base.twig',
            'zepto.default_list_template' => 'list.twig',
            'zepto.content_ext'           => array('.md', '.markdown'),
            'zepto.plugins_enabled'       => true,
            'site.site_root'              => 'http://localhost:8888/zepto/',
            'site.site_title'             => 'Zepto',
            'site.date_format'            => 'jS M Y',
            'site.excerpt_newline_limit'  => '5',
            'site.nav.class'              => 'nav',
            'site.nav.dropdown_li_class'  => 'dropdown',
            'site.nav.dropdown_ul_class'  => 'dropdown-menu',
            'site.nav.dropdown_li_markup' => '<li class="%s"><a href="%s" class="dropdown-toggle" data-toggle="dropdown"> %s <b class="caret"></b></a><ul class="%s">',
            'twig'                       => array(
                'charset'           => 'utf-8',
                'cache'             => 'cache',
                'strict_variables'  => false,
                'autoescape'        => false,
                'auto_reload'       => true
            )
        );
        $zepto = new Zepto($config);
        $this->assertEquals($config, $zepto->app['settings']);
    }

    /**
     * @covers Zepto\Zepto::__construct()
     */
    public function testDependenciesAdded()
    {
        $zepto = new Zepto();

        // Check for request
        $this->assertArrayHasKey('request', $zepto->app);
        $this->assertInstanceOf(
            'Symfony\Component\HttpFoundation\Request',
            $zepto->app['request']
        );

        // Check for response
        $this->assertArrayHasKey('response', $zepto->app);
        $this->assertInstanceOf(
            'Symfony\Component\HttpFoundation\Response',
            $zepto->app['response']
        );

        // Check for router
        $this->assertArrayHasKey('router', $zepto->app);
        $this->assertInstanceOf(
            'Zepto\Router',
            $zepto->app['router']
        );

        // Check for filesystem
        $this->assertArrayHasKey('filesystem', $zepto->app);
        $this->assertInstanceOf(
            'League\Flysystem\Filesystem',
            $zepto->app['filesystem']
        );

        // Check for helper
        $this->assertArrayHasKey('helper', $zepto->app);
        $this->assertInstanceOf(
            'Zepto\Helper',
            $zepto->app['helper']
        );

        // Check for Twig
        $this->assertArrayHasKey('twig', $zepto->app);
        $this->assertInstanceOf(
            '\Twig_Environment',
            $zepto->app['twig']
        );
        // Add check to see if extension is loaded in?
    }

    /**
     * @covers       Zepto\Zepto::__construct()
     * @dataProvider providerConfigs
     */
    public function testDependenciesAddedInProductionMode($config)
    {
        $zepto = new Zepto($config);

        // Check for request
        $this->assertArrayHasKey('request', $zepto->app);
        $this->assertInstanceOf(
            'Symfony\Component\HttpFoundation\Request',
            $zepto->app['request']
        );

        // Check for response
        $this->assertArrayHasKey('response', $zepto->app);
        $this->assertInstanceOf(
            'Symfony\Component\HttpFoundation\Response',
            $zepto->app['response']
        );

        // Check for router
        $this->assertArrayHasKey('router', $zepto->app);
        $this->assertInstanceOf(
            'Zepto\Router',
            $zepto->app['router']
        );

        // Check for filesystem
        $this->assertArrayHasKey('filesystem', $zepto->app);
        $this->assertInstanceOf(
            'League\Flysystem\Filesystem',
            $zepto->app['filesystem']
        );

        // Check for helper
        $this->assertArrayHasKey('helper', $zepto->app);
        $this->assertInstanceOf(
            'Zepto\Helper',
            $zepto->app['helper']
        );

        // Check for Twig
        $this->assertArrayHasKey('twig', $zepto->app);
        $this->assertInstanceOf(
            '\Twig_Environment',
            $zepto->app['twig']
        );
        // Add check to see if extension is loaded in?
    }

    /**
     * INITIALIZATION TESTS
     */

    /**
     * @covers Zepto\Zepto::load_plugins()
     */
    public function testLoadPlugins()
    {
        // Add assertion to check if plugins_enabled is true or not
        $zepto = new Zepto();
        $this->assertArrayNotHasKey('plugins', $zepto->app);
    }

    /**
     * @covers       Zepto\Zepto::load_plugins()
     * @dataProvider providerConfigs
     */
    public function testLoadPluginsInProductionMode($config)
    {
        $config['zepto.plugins_enabled'] = TRUE;
        // Add assertion to check if plugins_enabled is true or not
        $zepto = new Zepto($config);
        $this->assertArrayHasKey('plugins', $zepto->app);
        $plugins = $zepto->app['plugins'];
        $this->assertArrayHasKey('WhoopsPlugin', $zepto->app['plugins']);
        $this->assertArrayHasKey('NavGenPlugin', $zepto->app['plugins']);
    }

    /**
     * @covers Zepto\Zepto::setup_router()
     */
    public function testSetupRouter()
    {
        $zepto = new Zepto();
        $routes = $zepto->app['router']->routes();

        // Check that routes were added as HTTP GET requests
        $this->assertArrayHasKey('GET', $routes);

        // Check to see only expected routes
        $expected = array('#^/404/$#', '#^/$#', '#^/sub/$#', '#^/sub/page/$#');

        // Check that all routes have a callback function
        $this->assertContainsOnly('Zepto\Route', $routes['GET']);

        foreach ($expected as $route_regex) {
            $this->assertArrayHasKey($route_regex, $routes['GET']);
        }
    }

    /**
     * @covers       Zepto\Zepto::setup_router()
     * @dataProvider providerConfigs
     */
    public function testSetupRouterInProductionMode($config)
    {
        $zepto = new Zepto($config);
        $routes = $zepto->app['router']->routes();

        // Check that routes were added as HTTP GET requests
        $this->assertArrayHasKey('GET', $routes);

        // Check to see only expected routes
        $expected = array('#^/404/$#', '#^/$#', '#^/sub/$#', '#^/sub/page/$#');

        // Check that all routes have a callback function
        $this->assertContainsOnly('Zepto\Route', $routes['GET']);

        foreach ($expected as $route_regex) {
            $this->assertArrayHasKey($route_regex, $routes['GET']);
        }
    }

    /**
     * @covers Zepto\Zepto::run()
     */
    public function testRun()
    {
        ob_start();
        $zepto = new Zepto();
        $this->assertTrue($zepto->run());
        ob_end_clean();
    }

    /**
     * @covers       Zepto\Zepto::run()
     * @dataProvider providerConfigs
     */
    public function testRunInProductionMode($config)
    {
        ob_start();
        $zepto = new Zepto($config);
        $this->assertTrue($zepto->run());
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::run()
     */
    public function testRunError()
    {
        $_SERVER['REQUEST_URL']     = '/non-existent';
        $_SERVER['REQUEST_URI']     = '/non-existent';
        ob_start();
        $zepto = new Zepto();
        $this->assertFalse($zepto->run());
        ob_end_clean();
    }

    /**
     * @covers       Zepto\Zepto::run()
     * @dataProvider providerConfigs
     */
    public function testRunErrorInProductionMode($config)
    {
        $_SERVER['REQUEST_URL']     = '/non-existent';
        $_SERVER['REQUEST_URI']     = '/non-existent';
        ob_start();
        $zepto = new Zepto($config);
        $this->assertFalse($zepto->run());
        ob_end_clean();
    }

    /**
     * @covers Zepto\Zepto::run_hooks()
     */
    public function testRunHooks()
    {
        $zepto = new Zepto();
        $this->assertFalse($zepto->run_hooks('before_response_send'));
    }

    /**
     * @covers       Zepto\Zepto::run_hooks()
     * @dataProvider providerConfigs
     */
    public function testRunHooksInProductionMode($config)
    {
        $zepto = new Zepto($config);
        $this->assertTrue($zepto->run_hooks('before_response_send'));
    }

    /**
     * INSTANTIATION TESTS
     */

    /**
     * @covers Zepto\Zepto::instance()
     */
    public function testInstanceBeforeInitialization()
    {
        $this->assertNull(Zepto::instance());
    }

    /**
     * @covers Zepto\Zepto::instance()
     */
    public function testInstanceAfterInitialization()
    {
        $zepto = new Zepto();
        $this->assertInstanceOf('Zepto\Zepto', Zepto::instance());
    }

    /**
     * @covers Zepto\Zepto::instance()
     * @dataProvider providerConfigs
     */
    public function testInstanceAfterInitializationInProductionMode($config)
    {
        $zepto = new Zepto($config);
        $this->assertInstanceOf('Zepto\Zepto', Zepto::instance());
    }

    /**
     * @covers Zepto\Zepto::kill()
     */
    public function testKill()
    {
        $zepto = new Zepto();
        $this->assertInstanceOf('Zepto\Zepto', Zepto::instance());
        Zepto::kill();
        $this->assertNull(Zepto::instance());
    }

    /**
     * @covers Zepto\Zepto::kill()
     * @dataProvider providerConfigs
     */
    public function testKillInProductionMode($config)
    {
        $zepto = new Zepto($config);
        $this->assertInstanceOf('Zepto\Zepto', Zepto::instance());
        Zepto::kill();
        $this->assertNull(Zepto::instance());
    }

    /**
     * Returns a config with plugins enabled, and another with production mode enabled
     */
    public function providerConfigs()
    {
        return array(
            array(
                array(
                    'zepto.environment'           => 'dev',
                    'zepto.content_dir'           => 'content',
                    'zepto.plugins_dir'           => 'plugins',
                    'zepto.templates_dir'         => 'templates',
                    'zepto.default_template'      => 'base.twig',
                    'zepto.default_list_template' => 'list.twig',
                    'zepto.content_ext'           => array('.md', '.markdown'),
                    'zepto.plugins_enabled'       => true,
                    'site.site_root'              => 'http://localhost:8888/zepto/',
                    'site.site_title'             => 'Zepto',
                    'site.date_format'            => 'jS M Y',
                    'site.excerpt_newline_limit'  => '5',
                    'twig'                       => array(
                        'charset'           => 'utf-8',
                        'cache'             => 'cache',
                        'strict_variables'  => false,
                        'autoescape'        => false,
                        'auto_reload'       => true
                    )
                ),
                array(
                    'zepto.environment'           => 'production',
                    'zepto.content_dir'           => 'content',
                    'zepto.plugins_dir'           => 'plugins',
                    'zepto.templates_dir'         => 'templates',
                    'zepto.default_template'      => 'base.twig',
                    'zepto.default_list_template' => 'list.twig',
                    'zepto.content_ext'           => array('.md', '.markdown'),
                    'zepto.plugins_enabled'       => true,
                    'site.site_root'              => 'http://localhost:8888/zepto/',
                    'site.site_title'             => 'Zepto',
                    'site.date_format'            => 'jS M Y',
                    'site.excerpt_newline_limit'  => '5',
                    'twig'                       => array(
                        'charset'           => 'utf-8',
                        'cache'             => 'cache',
                        'strict_variables'  => false,
                        'autoescape'        => false,
                        'auto_reload'       => true
                    )
                )
            )
        );
    }

}
